<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />

  <title>Code archeology</title>

  <link rel="stylesheet" href="https://thewagner.net/theme/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <link href="https://thewagner.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="The Wagner Atom Feed" />


</head>

<body>
  <nav class="navbar" role="navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://thewagner.net/">The Wagner       </a>

      <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div class="navbar-menu" id="navMenu">
      <div class="navbar-start">
        <!-- Menu items -->
        <!-- Pages -->
        <!-- Categories -->
      </div>
      <div class="navbar-end">
          <a class="navbar-item" href="https://github.com/wagdav">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
        <a class="navbar-item" href="https://thewagner.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
        </a>
      </div>
    </div>
  </nav>

<section class="section">
  <div class="container is-max-desktop">
    <h1 class="title">
      <a href="https://thewagner.net/blog/2015/03/25/code-archeology/" rel="bookmark"
         title="Permalink to Code archeology">Code archeology</a></h1>

    <h2 class="subtitle">
<time class="published" datetime="2015-03-25T00:00:00+01:00">March 25, 2015</time>
<span class="vcard author">
    <a class="url fn" href="https://thewagner.net/author/david-wagner.html">David Wagner</a>
</span>
    </h2>

    <div class="content" style="hyphens:auto">
      <p>Back in 2004 a friend of mine was building a telescope and I wanted it to have
an automated control system, where the user can select a star she
wants to see and the system would automatically orient the telescope towards the
appropriate celestial coordinates.  I called this ambitious plan: &quot;Project Starfinder&quot;.  The plan was that he builds the telescope and I write the software.  We both did our job separately, but we never got around to put our works together.</p>
<p>Though Project Starfinder failed, the motor controller I built was quite a success.  The other day I was browsing through my old backups and I stumbled upon the code I wrote 11 years ago.  <tt class="docutils literal">motorc</tt> and <tt class="docutils literal">motord</tt> were the client and the server component, respectively, of my stepper motor controller.</p>
<div class="section" id="daemon">
<h2>Daemon</h2>
<p>The <tt class="docutils literal">motord</tt> daemon was responsible to receive messages from the connected clients and translate them to instructions to be written to the parallel port.  I also built a circuit that could drive four motors connected to the PCs parallel port.  The daemon needed to run with root privileges.</p>
<p>The daemon was accepting connections on a PF_LOCAL socket.  For each incoming connection the daemon forked off a child process to handle the one to one communication with the connected client.  I had read somewhere that Apache worked this way and I remember being quiet very to learn about <tt class="docutils literal">fork()</tt>.</p>
<p>I used <tt class="docutils literal">select</tt> on an <tt class="docutils literal">fd_set</tt> to process the incoming messages.  This caused me a lot of headaches.  I didn't really understand what was going on with these file descriptors.  Everything about them seemed magical.  I probably copied the respective code from a tutorial or somewhere.</p>
<p>Anyhow, the messages arrived from the socket and they were processed in a large switch-case:</p>
<div class="highlight"><pre><span></span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="cm">/* forking off */</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="cm">/* if we are a child process */</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">select</span><span class="w"> </span><span class="p">(</span><span class="n">FD_SETSIZE</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">set</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>
<span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="n">read</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">t_motor_command</span><span class="p">));</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">debug</span><span class="p">)</span>
<span class="w">         </span><span class="n">syslog</span><span class="w"> </span><span class="p">(</span><span class="n">LOG_DAEMON</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LOG_DEBUG</span><span class="p">,</span>
<span class="w">                 </span><span class="s">&quot;Instruction: 0x%x, Address: 0x%x&quot;</span><span class="p">,</span>
<span class="w">                 </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">,</span>
<span class="w">                 </span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">inst</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BYE</span><span class="p">)</span>
<span class="w">         </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="cm">/* TODO: a safer solution needed */</span>

<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="no">MOTOREN</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Motor enable */</span>
<span class="w">             </span><span class="n">motors</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">             </span><span class="k">break</span><span class="p">;</span>
<span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="no">MOTORDIS</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Motor disable */</span>
<span class="w">             </span><span class="n">motors</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">             </span><span class="k">break</span><span class="p">;</span>
<span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="no">MOTORR</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Direction right */</span>
<span class="w">             </span><span class="n">motors</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">             </span><span class="k">break</span><span class="p">;</span>
<span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="no">MOTORL</span><span class="p">:</span><span class="w"> </span><span class="cm">/* Direction left */</span>
<span class="w">             </span><span class="n">motors</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">             </span><span class="k">break</span><span class="p">;</span>
<span class="w">         </span><span class="k">case</span><span class="w"> </span><span class="no">MOTORCLR</span><span class="p">:</span><span class="w">     </span><span class="cm">/* clear the position */</span>
<span class="w">             </span><span class="n">motors</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">             </span><span class="k">break</span><span class="p">;</span>
<span class="w">         </span><span class="cm">/* ... */</span>
<span class="w">       </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>This is the code from the source file almost literally.  I used 8 spaces for indentation and apparently I didn't care about lines longer than 80 characters back then.</p>
<p>I developed a simple binary protocol to communicate over the socket.  The commands were represented by <tt class="docutils literal">t_motor_command</tt> data structure:</p>
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span>
<span class="p">{</span>
<span class="w">     </span><span class="n">WORD</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span><span class="w">  </span><span class="cm">/* instruction byte*/</span>
<span class="w">     </span><span class="n">WORD</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span><span class="w">  </span><span class="cm">/* motor address   */</span>
<span class="p">}</span><span class="w"> </span><span class="n">t_motor_command</span><span class="p">;</span>
</pre></div>
<p>Pretty standard stuff.</p>
<p>The motor daemon also had the following features:</p>
<ul class="simple">
<li>read and parsed a configuration file</li>
<li>supported arbitrary numbers of motors. In fact the motor objects were stored in a linked list.</li>
<li>wrote log messages to the syslog</li>
<li>changes in the motor position were made available to all clients</li>
<li>handled SIGTERM and SIGCHILD signals and made a clean exit</li>
<li>it was GPL licensed</li>
</ul>
<p>I didn't know how to use <tt class="docutils literal">valgrind</tt> or <tt class="docutils literal">gdb</tt> back then, so probably it leaked memory :-).</p>
</div>
<div class="section" id="graphical-client">
<h2>Graphical client</h2>
<p>My memories about development of the client application are more vague: it was much faster to develop it, and also it is much simpler program than the daemon.  I used Glade to design a GTK interface (with GTK 1.2).  I tried to compile the project in order to make some screenshots of the interface, but I failed.  The project depends on old libraries, moreover the newer version of Glade is having troubles reading the old interface files.</p>
<p>Anyway the interface was quite simple: it had four knobs for the four motors.  As the user turned the knobs the motors turned.  Very exciting!  If you opened multiple clients the knobs were synchronized (there was no position feedback from the motors).</p>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>Reading through the code brought back some nice memories about this project.  I had great fun designing the client-server architecture and I was really proud that I could handle multiple clients by forking off the server process.  It's a pity though that the code didn't move any telescopes...</p>
</div>

    </div><!-- /.entry-content -->
  </div>
</section>

  <section id="extras" class="body">
  </section><!-- /#extras -->

    <footer class="footer">
      <div class="content has-text-centered">
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
        <p>
          <small>Revision: <a href="https://github.com/wagdav/thewagner.net/commit/f64ed68">f64ed6</a></small>
        </p>
      </div>
    </footer><!-- /#contentinfo -->
</body>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Get all "navbar-burger" elements
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

    // Add a click event on each of them
    $navbarBurgers.forEach(el => {
      el.addEventListener('click', () => {
        // Get the target from the "data-target" attribute
        const target = el.dataset.target;
        const $target = document.getElementById(target);

        // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
        el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  });
</script>
</html>