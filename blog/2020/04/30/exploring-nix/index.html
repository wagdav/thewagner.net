<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />

  <title>Exploring Nix</title>

  <link rel="stylesheet" href="https://thewagner.net/theme/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <link href="https://thewagner.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="The Wagner Atom Feed" />


</head>

<body>
  <nav class="navbar" role="navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://thewagner.net/">The Wagner       </a>

      <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div class="navbar-menu" id="navMenu">
      <div class="navbar-start">
        <!-- Menu items -->
        <!-- Pages -->
        <!-- Categories -->
      </div>
      <div class="navbar-end">
          <a class="navbar-item" href="https://github.com/wagdav">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
        <a class="navbar-item" href="https://thewagner.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
        </a>
      </div>
    </div>
  </nav>

<section class="section">
  <div class="container is-max-desktop">
    <h1 class="title">
      <a href="https://thewagner.net/blog/2020/04/30/exploring-nix/" rel="bookmark"
         title="Permalink to Exploring Nix">Exploring Nix</a></h1>

    <h2 class="subtitle">
<time class="published" datetime="2020-04-30T00:00:00+02:00">April 30, 2020</time>
<span class="vcard author">
    <a class="url fn" href="https://thewagner.net/author/david-wagner.html">David Wagner</a>
</span>
    </h2>

    <div class="content" style="hyphens:auto">
      <p>For the last few weeks I've been exploring <a href="https://nixos.org/">NixOS</a> and its
related tools.  This article is an experience report and a collection of
learning material I find useful.</p>
<p>NixOS is a unique Linux distribution with <a href="https://en.wikipedia.org/wiki/NixOS">origins</a> in
<a href="https://edolstra.github.io/pubs/phd-thesis.pdf">research</a> conducted at Utrecht University.  NixOS handles
software delivery and configuration in a different way than any other
distribution I know.  The entire operating system is treated as an immutable
value which  makes deploying and maintaining NixOS-based systems easy and
reliable.</p>
<h1>The language</h1>
<p>NixOS is configured using the
<a href="https://nixos.org/nix/manual/#ch-expression-language">Nix expression language</a>:
a small, purely functional programming language.  Besides the usual data types
(booleans, numbers, strings, lists and sets) Nix has some features which are
uncommon in configuration languages.</p>
<p>Let blocks bind values to symbols. The bindings appear after the keyword <code>let</code>
and the symbols can be used after the keyword <code>in</code>.  For example, the
expression:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span>
  <span class="ss">x</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span><span class="p">;</span>
  <span class="ss">y</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span><span class="p">;</span>
<span class="k">in</span>
  x <span class="o">+</span> y <span class="o">+</span> x
</code></pre></div>

<p>evaluates to <code>"aba"</code>.</p>
<p>In Nix, functions are first-class values.  A function which adds one to a
value is defined succinctly:</p>
<div class="highlight"><pre><span></span><code>n<span class="p">:</span> n <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>

<p>Typically, functions take sets as arguments and return sets as results.  This
expression defines and calls the <code>endpoints</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="k">let</span>
  <span class="ss">endpoints</span> <span class="o">=</span> <span class="p">{</span> engine<span class="p">,</span> domain <span class="p">}:</span> <span class="p">{</span>
    <span class="ss">http</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">${</span>engine<span class="si">}</span><span class="s2">.</span><span class="si">${</span>domain<span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
    <span class="ss">https</span> <span class="o">=</span> <span class="s2">&quot;https://</span><span class="si">${</span>engine<span class="si">}</span><span class="s2">.</span><span class="si">${</span>domain<span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
  <span class="p">};</span>
<span class="k">in</span>
  endpoints <span class="p">{</span> <span class="ss">engine</span> <span class="o">=</span> <span class="s2">&quot;google&quot;</span><span class="p">;</span> <span class="ss">domain</span> <span class="o">=</span> <span class="s2">&quot;com&quot;</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>

<p>which evaluates to:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span> <span class="ss">http</span> <span class="o">=</span> <span class="s2">&quot;http://google.com&quot;</span><span class="p">;</span> <span class="ss">https</span> <span class="o">=</span> <span class="s2">&quot;https://google.com&quot;</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>

<p>This last example also shows how symbols in the current scope are interpolated
in strings using <code>${}</code>.</p>
<p>These constructs are sufficient to read the examples in this article.  For a
comprehensive overview of the language features see <a href="https://learnxinyminutes.com/docs/nix/">this tutorial</a>.</p>
<h1>Derivations</h1>
<p>A <em>derivation</em>, a core concept of Nix, is a build recipe: it describes how to
obtain, in other words <em>derive</em>, a component from its inputs.  Let's make this
statement more concrete with an example.</p>
<p>We will use Nix to put a string into a file using a build action equivalent to:</p>
<div class="highlight"><pre><span></span><code><span class="go">echo hello from Nix &gt; output.txt</span>
</code></pre></div>

<p>This build runs the <code>echo</code> shell command to generate a file.  The build
requires no input source files, but a shell to be present.  We could use <code>bash</code>
but from where do we get its executable?</p>
<p>Typical build systems assume that certain programs are available in the build
environment.  Nix doesn't make such assumptions.  Builds are performed in
isolation: no programs, no environment variables, nor access to the outside
world are available unless explicitly specified.</p>
<p>In programming we use a function to abstract over an input parameter of a
computation.  Let's do the same and write a function which takes <code>bash</code> as
input and returns the build recipe, a derivation:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># hello.nix</span>
<span class="p">{</span> bash <span class="p">}</span> <span class="p">:</span>

<span class="nb">derivation</span> <span class="p">{</span>
  <span class="ss">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
  <span class="ss">builder</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">${</span>bash<span class="si">}</span><span class="s2">/bin/bash&quot;</span><span class="p">;</span>
  <span class="ss">args</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;-c&quot;</span> <span class="s2">&quot;echo hello from Nix &gt; $out&quot;</span> <span class="p">];</span>
  <span class="ss">system</span> <span class="o">=</span> <span class="nb">builtins</span><span class="o">.</span>currentSystem<span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><code>derivation</code> is keyword of the Nix language.  It's represented as a set with
specific attributes: a name, a program and its arguments to produce some
output, and a specification of the operating system's architecture where this
derivation can be built.</p>
<p>The <code>bash</code> argument is a dependency, it refers to a derivation which must be
built before the <code>hello</code> derivation.</p>
<p>To understand better the derivation's structure, let's assume we have <code>bash</code>
built and we evaluate the <code>hello</code> derivation.  Nix stores the resulting
derivation in the following structure:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;/nix/store/61lcv6k65f42d3v8nww7m7k48h7v9mhy-hello.drv&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;outputs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/nix/store/qcnf97fclrnqppq3h5ld9smqdb8l2ybk-hello&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;inputSrcs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">    </span><span class="nt">&quot;inputDrvs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;/nix/store/8ynv2wxv6vaa75sbpmz8rnlbv1bxcfzn-bash-4.4-p23.drv&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;out&quot;</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;platform&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;x86_64-linux&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;builder&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/nix/store/9si14qjcz8072c0v42zbkglq08s2cg04-bash-4.4-p23/bin/bash&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;-c&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;echo hello from Nix &gt; $out&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;env&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;builder&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/nix/store/9si14qjcz8072c0v42zbkglq08s2cg04-bash-4.4-p23/bin/bash&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;hello&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/nix/store/qcnf97fclrnqppq3h5ld9smqdb8l2ybk-hello&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;system&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;x86_64-linux&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>In this representation we can see how Nix stores the build artifacts under
<code>/nix/store</code>.  The filenames in the store are cryptographic hashes of the
defining Nix expression suffixed with a readable, user-provided name.</p>
<p>This data structure is a concrete description how to build the <code>hello</code>
greeting:</p>
<ul>
<li>
<p><em>Outputs</em>: the derivation yields one output named <code>out</code>.  The output will be
  stored under the given path.</p>
</li>
<li>
<p><em>InputSrcs</em>: the derivation requires no input sources</p>
</li>
<li>
<p><em>InputDrvs</em>: the derivation depends on the derivation which builds <code>bash</code>.</p>
</li>
<li>
<p><em>Platform</em>: on my PC the expression <code>builtin.currentSystem</code> evaluates to <code>x86_64_linux</code>.</p>
</li>
<li>
<p><em>Builder and args</em>: the program and its arguments we provided, but now
  referencing concrete artifacts in the store.</p>
</li>
<li>
<p><em>Env</em>: the environment variables available during build.  These are
  originating from the derivation's attributes we provided in the Nix
  expression.  We reference <code>$out</code> in the build script.</p>
</li>
</ul>
<p>Derivations are just data without any knowledge of the Nix language.  When
evaluated, a Nix expression typically produces many, interdependent derivations
which are built in topological order, that is each derivation is built after
their dependent derivations.</p>
<p>Nix builds a component in two stages:</p>
<ol>
<li>Evaluates the expression and writes resulting derivations in the Nix store.</li>
<li>Builds the derivation and writes build results in the Nix store.</li>
</ol>
<p>Nix expressions provide a high-level language for developers to define
components, component configuration and component relationships.  Derivations
encode build instructions for a single component for a given configuration in a
well-defined environment.</p>
<p>Nix expressions can be evaluated on any system where Nix is installed.
Derivations may be copied to other nodes for building: to a build farm, or to
nodes with special hardware.</p>
<h1>Build the example</h1>
<p>To build the example in the previous section, save the expression in a file
named <code>hello.nix</code> and run:</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>nix-build<span class="w"> </span>hello.nix<span class="w"> </span>--arg<span class="w"> </span>bash<span class="w"> </span><span class="s1">&#39;(import &lt;nixpkgs&gt; {}).bash&#39;</span>
<span class="go">/nix/store/qcnf97fclrnqppq3h5ld9smqdb8l2ybk-hello</span>
</code></pre></div>

<p>The <code>--arg</code> switch tells Nix to use the <code>bash</code> package from the <a href="https://nixos.org/nixos/packages.html">Nix Packages
collection</a>.  <code>nix-build</code> prints the path where the build result is
stored.  By default, <code>nix-build</code> also creates a symbolic link to the build
result in the current working directory so it's easy to verify if we find the
string we expect:</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span>&lt;<span class="w"> </span>result
<span class="go">hello from Nix</span>
</code></pre></div>

<p>To see the internal structure of the derivation, run the command:</p>
<div class="highlight"><pre><span></span><code><span class="go">nix show-derivation /nix/store/qcnf97fclrnqppq3h5ld9smqdb8l2ybk-hello</span>
</code></pre></div>

<p>which outputs data structure as shown in the previous section.</p>
<h1>Composing an operating system</h1>
<p>The Nix language provides a clean component description formalism: <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/all-packages.nix">a single
expression</a> builds 40000 packages on multiple platforms.  To
achieve this scale, higher-level abstractions are built from the Nix language
primitives.</p>
<p><a href="https://nixos.wiki/wiki/Module">Modules</a> are functions which return a set with specific
attributes:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span> config<span class="p">,</span> pkgs<span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>

<span class="p">{</span>
  <span class="ss">imports</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># paths to other modules</span>
  <span class="p">];</span>

  <span class="ss">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># option declarations</span>
  <span class="p">};</span>

  <span class="ss">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># option definitions</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>

<p>Modules are useful for configuring complete subsystems such as networking,
printing, graphics and so on.  The top-level NixOS configuration, typically
stored in <code>/etc/nixos/configuration.nix</code>, is a module itself which may include
other modules.</p>
<p>For example, the <a href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/networking/firewall.nix">firewall module</a> allows you to specify the
open ports of your system:</p>
<div class="highlight"><pre><span></span><code>networking<span class="o">.</span>firewall<span class="o">.</span><span class="ss">allowedTCPPorts</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">80</span> <span class="p">];</span>
</code></pre></div>

<p>The module keeps the intricacies of generating iptables rules within its
implementation.  Our system configuration remains simple and declarative.</p>
<h1>Applications</h1>
<p>The existence of <a href="http://nixos.org">NixOS</a> proves that the Nix expression
language is a solid foundation for software packaging and software delivery.
NixOS is not the most popular <a href="https://distrowatch.com/table.php?distribution=nixos">Linux
distribution</a> today, but
if you felt the pain of server management using tools like Puppet, Salt or
Ansible, you should definitely give NixOS a try.</p>
<p>You don't have to replace your operating system to try Nix.  You can use Nix
packages on <a href="https://nixos.org/nix/">Linux and Mac systems</a> to set up and share
build environments for your projects, regardless of what programming languages
and tools you're using.</p>
<p>The Nix model can also be used to <a href="https://github.com/NixOS/nixops">deploy
servers</a> and for <a href="https://github.com/NixOS/hydra">continuous integration and
delivery</a>.</p>
<h1>Learn more</h1>
<p>This section is a collection of online resources which I find useful to learn
about Nix.</p>
<p>Learn the Nix language:</p>
<ul>
<li><a href="https://learnxinyminutes.com/docs/nix/">Learn X in Y minutes where X=Nix</a></li>
<li><a href="https://nixos.org/nix/manual/#ch-expression-language">Nix Expression Language section of the Nix Manual</a></li>
</ul>
<p>Learn about modules and overlays:</p>
<ul>
<li><a href="https://nixos.wiki/wiki/Module">Modules</a></li>
<li><a href="https://nixos.wiki/wiki/Overlays">Overlays</a></li>
</ul>
<p>Browse Nix packages and NixOS options:</p>
<ul>
<li><a href="https://nixos.org/nixos/packages.html">Search NixOS packages</a></li>
<li><a href="https://nixos.org/nixos/options.html">Search NixOS options</a></li>
</ul>
<p>Read about the original research:</p>
<ul>
<li><a href="https://edolstra.github.io/pubs/iscsd-scm11-final.pdf">Integrating Software Construction and Software Deployment</a>
   (Nix used to be called Maak)</li>
<li><a href="https://edolstra.github.io/pubs/phd-thesis.pdf">The Purely Functional Software Deployment Model</a></li>
</ul>
<p>Additionally, the NixOS Wiki contains <a href="https://nixos.wiki/wiki/Resources">a list of learning resources</a>.</p>
<h1>Summary</h1>
<p>After a few weeks of learning I'm amazed by Nix.  I believe NixOS is the best
operating system to deploy from a declarative configuration.  The expression
language, the Nix store, the evaluation and build strategy were built for
painless software deployments.</p>
<p>If you value infrastructure as code and immutable deployments you should
definitely spend time on Nix and its core concepts.</p>
<p>I updated my main laptop and my servers at home to NixOS.  The configuration of
all my machines is <a href="https://github.com/wagdav/homelab">available on GitHub</a>.</p>
    </div><!-- /.entry-content -->
  </div>
</section>

  <section id="extras" class="body">
  </section><!-- /#extras -->

    <footer class="footer">
      <div class="content has-text-centered">
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" width="88" height="31"/></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
        <p>
          <small>Revision: <a href="https://github.com/wagdav/thewagner.net/commit/bb56ba7">bb56ba</a></small>
        </p>
      </div>
    </footer><!-- /#contentinfo -->
</body>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Get all "navbar-burger" elements
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

    // Add a click event on each of them
    $navbarBurgers.forEach(el => {
      el.addEventListener('click', () => {
        // Get the target from the "data-target" attribute
        const target = el.dataset.target;
        const $target = document.getElementById(target);

        // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
        el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  });
</script>
</html>