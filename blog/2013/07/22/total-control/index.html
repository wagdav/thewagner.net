<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K7WDT4BQRY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-K7WDT4BQRY');
    </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />

  <title>Total control</title>

  <link rel="stylesheet" href="https://thewagner.net/theme/css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <link href="https://thewagner.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="The Wagner Atom Feed" />


</head>

<body>
  <nav class="navbar" role="navigation">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://thewagner.net/">The Wagner       </a>

      <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div class="navbar-menu" id="navMenu">
      <div class="navbar-start">
        <!-- Menu items -->
        <!-- Pages -->
        <!-- Categories -->
      </div>
      <div class="navbar-end">
          <a class="navbar-item" href="https://github.com/wagdav">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
        <a class="navbar-item" href="https://thewagner.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
        </a>
      </div>
    </div>
  </nav>

<section class="section">
  <div class="container is-max-desktop">
    <h1 class="title">
      <a href="https://thewagner.net/blog/2013/07/22/total-control/" rel="bookmark"
         title="Permalink to Total control">Total&nbsp;control</a></h1>

    <h2 class="subtitle">
<time class="published" datetime="2013-07-22T00:00:00+02:00">July 22, 2013</time>
<span class="vcard author">
    <a class="url fn" href="https://thewagner.net/author/david-wagner.html">David Wagner</a>
</span>
    </h2>

    <div class="content" style="hyphens:auto">
      <p>I ordered some electronic components from <a class="reference external" href="http://play-zone.ch">Play-Zone</a> which made me really easy to control my unipolar stepper motor and read data from a 10k&nbsp;potentiometer.</p>
<div class="section" id="stepper-motor">
<h2>Stepper&nbsp;motor</h2>
<p>After sufficient <a class="reference external" href="https://thewagner.net/blog/2013/07/19/prototypes-for-stepper-motor-control/">preparation</a>, it took me less than 15 minutes to have a nicely purring and turning stepper motor on the breadboard.  The key element, a <span class="caps">ULN2803A</span> containing 8 Darlington Arrays, takes care of&nbsp;everything.</p>
<img alt="Stepper motor schema" src="https://thewagner.net/images/pi/stepper_prototype_3_schem.png" />
</div>
<div class="section" id="potentiometer">
<h2>Potentiometer</h2>
<p>Not strictly related, but in the same go I used the newly arrived <span class="caps">MCP3002</span> <span class="caps">ADC</span> to read the position of a 10k potentiometer.  I borrowed some code from the <a class="reference external" href="http://learn.adafruit.com/reading-a-analog-in-and-controlling-audio-volume-with-the-raspberry-pi/overview">Adafruit website</a> with some modifications from <a class="reference external" href="http://dmt195.wordpress.com/2012/09/26/mcp3002-example-code-for-raspberry-pi-adc-through-spi/">here</a>.</p>
<img alt="Potentiometer schema" src="https://thewagner.net/images/pi/potentiometer_schem.png" />
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">RPi.GPIO</span> <span class="k">as</span> <span class="nn">GPIO</span>

<span class="n">GPIO</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">GPIO</span><span class="o">.</span><span class="n">BOARD</span><span class="p">)</span>

<span class="c1"># read SPI data from MCP3002 chip, 2 possible adc&#39;s (0 thru 1)</span>
<span class="k">def</span> <span class="nf">readadc</span><span class="p">(</span><span class="n">adcnum</span><span class="p">,</span> <span class="n">clockpin</span><span class="p">,</span> <span class="n">mosipin</span><span class="p">,</span> <span class="n">misopin</span><span class="p">,</span> <span class="n">cspin</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">adcnum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">adcnum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)):</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">cspin</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">clockpin</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># start clock low</span>
        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">cspin</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>     <span class="c1"># bring CS low</span>

        <span class="k">if</span> <span class="n">adcnum</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">commandout</span> <span class="o">=</span> <span class="mh">0x6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commandout</span> <span class="o">=</span> <span class="mh">0x7</span>
        <span class="n">commandout</span> <span class="o">&lt;&lt;=</span> <span class="mi">5</span>    <span class="c1"># we only need to send 3 bits here</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">commandout</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">):</span>
                        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">mosipin</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">mosipin</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">commandout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
                <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">clockpin</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">clockpin</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">adcout</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># read in one empty bit, one null bit and 10 ADC bits</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
                <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">clockpin</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">clockpin</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">adcout</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">GPIO</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">misopin</span><span class="p">)):</span>
                        <span class="n">adcout</span> <span class="o">|=</span> <span class="mh">0x1</span>

        <span class="n">GPIO</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">cspin</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">adcout</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>       <span class="c1"># first bit is &#39;null&#39; so drop it</span>
        <span class="k">return</span> <span class="n">adcout</span>

<span class="n">SPICS</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">SPIMOSI</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">SPIMISO</span> <span class="o">=</span> <span class="mi">21</span>
<span class="n">SPICLK</span> <span class="o">=</span> <span class="mi">23</span>

<span class="c1"># set up the SPI interface pins</span>
<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">SPIMOSI</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">SPIMISO</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">SPICLK</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
<span class="n">GPIO</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">SPICS</span><span class="p">,</span> <span class="n">GPIO</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>

<span class="c1"># 10k trim pot connected to adc #0</span>
<span class="n">potentiometer_adc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">last_read</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># this keeps track of the last potentiometer value</span>
<span class="n">tolerance</span> <span class="o">=</span> <span class="mi">5</span>       <span class="c1"># to keep from being jittery we&#39;ll only change</span>
                    <span class="c1"># volume when the pot has moved more than 5 &#39;counts&#39;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># we&#39;ll assume that the pot didn&#39;t move</span>
        <span class="n">trim_pot_changed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># read the analog pin</span>
        <span class="n">trim_pot</span> <span class="o">=</span> <span class="n">readadc</span><span class="p">(</span><span class="n">potentiometer_adc</span><span class="p">,</span> <span class="n">SPICLK</span><span class="p">,</span> <span class="n">SPIMOSI</span><span class="p">,</span> <span class="n">SPIMISO</span><span class="p">,</span> <span class="n">SPICS</span><span class="p">)</span>
        <span class="c1"># how much has it changed since the last read?</span>
        <span class="n">pot_adjust</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">trim_pot</span> <span class="o">-</span> <span class="n">last_read</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pot_adjust</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">):</span>
               <span class="n">trim_pot_changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">trim_pot_changed</span><span class="p">:</span>
                <span class="c1"># convert 10bit adc0 (0-1024) trim pot read into</span>
                <span class="c1"># 0-100 volume level</span>
                <span class="n">set_volume</span> <span class="o">=</span> <span class="n">trim_pot</span> <span class="o">/</span> <span class="mf">10.24</span>
                <span class="n">set_volume</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">set_volume</span><span class="p">)</span>  <span class="c1"># round out decimal value</span>
                <span class="n">set_volume</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">set_volume</span><span class="p">)</span>  <span class="c1"># cast volume as integer</span>

                <span class="nb">print</span> <span class="s1">&#39;volume = </span><span class="si">{volume}</span><span class="s1">%&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">volume</span> <span class="o">=</span> <span class="n">set_volume</span><span class="p">)</span>

                <span class="c1"># save the potentiometer reading for the next loop</span>
                <span class="n">last_read</span> <span class="o">=</span> <span class="n">trim_pot</span>

        <span class="c1"># hang out and do nothing for a half second</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
<p>These two (independent) circuits make a big mess on the breadboard, but it was a lot of fun to wire it up.  Now I can read analog as well as digital inputs from the real world with the Raspberry Pi!&nbsp;Yay!</p>
<img alt="Potentiometer breadboard" src="https://thewagner.net/images/pi/potentiometer_breadboard.jpg" />
</div>

    </div><!-- /.entry-content -->
  </div>
</section>

  <section id="extras" class="body">
  </section><!-- /#extras -->

    <footer class="footer">
      <div class="content has-text-centered">
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
        <p>
          <small>Revision: <a href="https://github.com/wagdav/thewagner.net/commit/713783d">713783</a></small>
        </p>
      </div>
    </footer><!-- /#contentinfo -->
</body>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Get all "navbar-burger" elements
    const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

    // Add a click event on each of them
    $navbarBurgers.forEach(el => {
      el.addEventListener('click', () => {
        // Get the target from the "data-target" attribute
        const target = el.dataset.target;
        const $target = document.getElementById(target);

        // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
        el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  });
</script>
</html>